<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Traffic Signal Control - RL</title>
    <!-- Google Fonts for Premium Look -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Outfit:wght@300;500;700&display=swap"
        rel="stylesheet">

    <link rel="stylesheet" href="css/style.css">
    <!-- Chart.js for Visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <div id="reporting"
        style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); color:white; font-family:monospace; padding:20px; z-index:9999; overflow:auto; display:none;">
        <!-- Error Overlay -->
        <div id="debug-error-overlay"
            style="color: #f87171; background: rgba(0,0,0,0.8); padding: 10px; border-radius: 4px; margin-bottom: 10px; white-space: pre-wrap; font-family: monospace; font-size: 12px;">
            <strong>Runtime Error:</strong><span id="debug-error-msg"></span>
            <button onclick="document.getElementById('reporting').style.display='none'"
                style="margin-top: 10px; padding: 5px 10px; background: #f87171; border: none; border-radius: 3px; cursor: pointer; color: white;">Close</button>
        </div>

        <!-- Logic Debug -->
        <div id="debug-info" style="margin-bottom: 10px; color: #fbbf24; font-family: monospace; font-size: 12px;">
            <div>Mode: <span id="dbg-mode">--</span></div>
            <div>Timer: <span id="dbg-timer">--</span></div>
            <div>Q(N/S): <span id="dbg-qns">--</span> | Q(E/W): <span id="dbg-qew">--</span></div>
        </div>
    </div>
    <script>
        window.onerror = function (msg, url, line, col, error) {
            const overlay = document.getElementById('debug-error-overlay'); // Get the element
            overlay.style.display = 'block';
            document.getElementById('debug-error-msg').innerText += `\n[Runtime Error] ${msg}\nLocation: ${url}:${line}:${col}\nStack: ${error ? error.stack : 'N/A'}\n`;
            return false;
        };
        console.error = (function (oldFn) {
            return function (...args) {
                oldFn(...args);
                const overlay = document.getElementById('debug-error-overlay');
                // Only show if overlay is already active or critical
            };
        })(console.error);
    </script>

    <div class="container">
        <!-- Sidebar / Control Panel -->
        <aside class="sidebar">
            <div class="logo">
                <h1>Neuro<span class="highlight">Traffic</span></h1>
                <p>RL-Powered Signal Control</p>
            </div>

            <div class="stats-card">
                <h3>Metrics</h3>
                <div class="stat-row">
                    <span>Avg Wait Time</span>
                    <span id="avg-wait" class="value">0.0s</span>
                </div>
                <div class="stat-row">
                    <span>Throughput</span>
                    <span id="throughput" class="value">0/min</span>
                </div>
                <div class="stat-row">
                    <span>Exploration (Îµ)</span>
                    <span id="epsilon" class="value">1.00</span>
                </div>
                <div class="stat-row">
                    <span>Reward</span>
                    <span id="reward" class="value">0</span>
                </div>
            </div>

            <div class="controls">
                <h3>Controls</h3>
                <button id="btn-reset" class="btn secondary">Reset Simulation</button>
                <button id="btn-save" class="btn secondary">Save Brain</button>
                <button id="btn-load" class="btn secondary">Load Brain</button>

                <div class="slider-group">
                    <label>Sim Speed: <span id="speed-val">1x</span></label>
                    <input type="range" id="sim-speed" min="1" max="100" value="1">
                </div>
            </div>

            <div class="chart-container">
                <canvas id="perf-chart"></canvas>
            </div>
        </aside>

        <!-- Main Simulation Area -->
        <main class="simulation-view">
            <canvas id="sim-canvas"></canvas>
            <div class="overlay-info">
                Episode: <span id="episode-count">1</span> | Step: <span id="step-count">0</span>
            </div>
        </main>
    </div>

    <!-- Scripts -->
    <script src="js/utils.js"></script>
    <script src="js/lib/neuro.js"></script>
    <script src="js/simulation.js"></script>
    <script src="js/agent.js"></script>
    <script src="js/main.js"></script>
</body>

</html>